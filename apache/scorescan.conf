<VirtualHost *:80>
    ServerName scorescan.example.com
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName scorescan.example.com
    
    # SSL Configuration (adjust paths to your certificates)
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/scorescan.crt
    SSLCertificateKeyFile /etc/ssl/private/scorescan.key
    # SSLCertificateChainFile /etc/ssl/certs/chain.crt
    
    # Modern SSL settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/scorescan_error.log
    CustomLog ${APACHE_LOG_DIR}/scorescan_access.log combined
    
    # Enable required modules (ensure these are enabled):
    # a2enmod proxy proxy_http proxy_wstunnel rewrite ssl headers
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Backend API - proxy to FastAPI backend
    ProxyPass /api http://localhost:8000/api
    ProxyPassReverse /api http://localhost:8000/api
    
    # API documentation endpoints
    ProxyPass /docs http://localhost:8000/docs
    ProxyPassReverse /docs http://localhost:8000/docs
    ProxyPass /redoc http://localhost:8000/redoc
    ProxyPassReverse /redoc http://localhost:8000/redoc
    ProxyPass /openapi.json http://localhost:8000/openapi.json
    ProxyPassReverse /openapi.json http://localhost:8000/openapi.json
    
    # Health check endpoint
    ProxyPass /health http://localhost:8000/health
    ProxyPassReverse /health http://localhost:8000/health
    
    # Frontend - proxy to Vite dev server (development) or serve static files (production)
    # Option 1: Development - proxy to Vite dev server
    # ProxyPass / http://localhost:5173/
    # ProxyPassReverse / http://localhost:5173/
    
    # Option 2: Production - serve built static files
    DocumentRoot /var/www/scorescan/dist
    
    <Directory /var/www/scorescan/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Handle client-side routing (SPA)
        FallbackResource /index.html
    </Directory>
    
    # Ensure API routes are not handled by FallbackResource
    <Location /api>
        ProxyPass http://localhost:8000/api
        ProxyPassReverse http://localhost:8000/api
    </Location>
    
    # WebSocket support (if needed for hot reload in development)
    # RewriteEngine On
    # RewriteCond %{HTTP:Upgrade} websocket [NC]
    # RewriteCond %{HTTP:Connection} upgrade [NC]
    # RewriteRule ^/?(.*) ws://localhost:5173/$1 [P,L]
    
    # Increase timeouts for long-running requests (file uploads, processing)
    ProxyTimeout 300
    
    # Increase max upload size (50MB to match backend)
    LimitRequestBody 52428800
</VirtualHost>
